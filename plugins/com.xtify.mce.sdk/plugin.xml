<?xml version="1.0" encoding="UTF-8"?>
<!--
 Licensed Materials - Property of IBM
 5725E28, 5725I03
 © Copyright IBM Corp. 2011, 2015
 US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
 -->
<plugin xmlns="http://apache.org/cordova/ns/plugins/1.0" id="com.xtify.mce.sdk"
version="3.6.1">
    <name>IBM MCE Cordova Plugin</name>
    <author>IBM MCE</author>
    <description>Allows Cordova applications to integrate with IBM MCE Push Services</description>
    <keywords>mce</keywords>
    <license>Apache 2.0 License</license>
    <engines>
        <engine name="cordova" version=">=3.0" />
    </engines>
    <js-module src="MCEPlugin.js" name="MCEPlugin">
        <clobbers target="MCEPlugin" />
    </js-module>

    <preference name="CHANNEL_NAME" default="MCE SDK Notification Channel" />
    <preference name="CHANNEL_DESCRIPTION" default="This is the notification channel for the MCE SDK sample application"/>
    <preference name="CHANNEL_ID" default="mce_sample_channel"/>

    <preference name="LOGLEVEL" default="error" />
    <preference name="SERVER_URL" default="https://api.ibm.xtify.com" />
    <preference name="IOS_PROD_APPKEY" />
    <preference name="IOS_DEV_APPKEY" />
    <preference name="CUSTOM_ACTIONS" default="none" />
    <preference name="INVALIDATE_EXISTING_USER" default="false" />
    <preference name="AUTO_REINITIALIZE" default="true" />
    <preference name="ANDROID_APPKEY" />
    <platform name="ios">
        <framework src="src/ios/IBMMobilePush.framework" custom="true" />
        <framework src="CoreTelephony.framework" />
        <framework src="CoreLocation.framework" />
        <framework src="libsqlite3.dylib" />
        <header-file src="src/ios/AppDelegate+MCE.h" />
        <source-file src="src/ios/AppDelegate+MCE.m" />
        <header-file src="src/ios/MCEPlugin.h" />
        <source-file src="src/ios/MCEPlugin.m" />
        <header-file src="src/ios/MCEEventCallbackQueue.h" />
        <source-file src="src/ios/MCEEventCallbackQueue.m" />
        <config-file target="config.xml" parent="/*">
            <feature name="MCEPlugin" >
                <param name="ios-package" value="MCEPlugin"/>
            </feature>
            <preference name="baseUrl" value="$SERVER_URL" />
            <preference name="prodAppKey" value="$IOS_PROD_APPKEY" />
            <preference name="devAppKey" value="$IOS_DEV_APPKEY" />
            <preference name="autoInitialize" value="true" />
            <preference name="customActions" value="$CUSTOM_ACTIONS" />
            <preference name="loglevel" value="$LOGLEVEL" />
            <preference name="invalidateExistingUser" value="$INVALIDATE_EXISTING_USER" />
            <preference name="autoReinitialize" value="$AUTO_REINITIALIZE" />
        </config-file>
        <config-file target="*-Info.plist" parent="UIBackgroundModes">
            <array>
                <string>remote-notification</string>
            </array>
        </config-file>

        <config-file target="*-Info.plist" parent="NSLocationAlwaysAndWhenInUseUsageDescription">
            <string>Be notified when interesting things are nearby</string>
        </config-file>
        <config-file target="*-Info.plist" parent="NSLocationAlwaysUsageDescription">
            <string>Be notified when interesting things are nearby</string>
        </config-file>
        <config-file target="*-Info.plist" parent="NSLocationWhenInUseUsageDescription">
            <string>Be notified when interesting things are nearby</string>
        </config-file>
    </platform>
    <platform name="android">
    	<hook src="scripts/after_prepare.js" type="after_prepare" />

        <!-- 
        <framework src="com.google.android.gms:play-services-gcm:+" />
        -->
        <framework src="com.google.android.gms:play-services-base:+" />
        <framework src="com.google.android.gms:play-services-auth:+" />
        <framework src="com.google.firebase:firebase-messaging:+" />

        <!--  Sets the changes that need to be made to AndroidManifest.xml
                in the selected parent element. For separate parents, make sure
                to use separate <config-file> elements with the proper parent.
                These changes are applied by AppBuilder during the build process.-->

        <edit-config file="AndroidManifest.xml" target="/manifest/application" mode="overwrite">
            <application android:hardwareAccelerated="true" android:icon="@mipmap/icon" android:label="@string/app_name" android:name="com.ibm.mce.sdk.js.MceJsonApplication" android:supportsRtl="true" />
        </edit-config>

        <config-file target="AndroidManifest.xml" parent="/manifest">

            <!-- C2D_MESSAGE is required for receiving GCM messages -->
            <permission
                android:name="$PACKAGE_NAME.permission.C2D_MESSAGE"
                android:protectionLevel="signature" />

            <!-- C2D_MESSAGE is required for receiving GCM messages -->
            <uses-permission android:name="$PACKAGE_NAME.permission.C2D_MESSAGE" />
             
            <!-- c2dm.permission.RECEIVE is required for receiving GCM messages -->
            <uses-permission android:name="com.google.android.c2dm.permission.RECEIVE" />
            
            <!-- INTERNET is required for calling the MCE server -->
            <uses-permission android:name="android.permission.INTERNET" />
            <!-- WAKE_LOC is required for running scheduled tasks -->
            <uses-permission android:name="android.permission.WAKE_LOCK" />
            <!-- RECEIVE_BOOT_COMPLETED is required for performing SDK task on device startup -->
            <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
            <!-- VIBRATE is required for notification configuration -->
            <uses-permission android:name="android.permission.VIBRATE" />
            <!-- CALL_PHONE is optional. It is only required is the dial action is used -->
            <uses-permission android:name="android.permission.CALL_PHONE" />
        </config-file>
        <config-file target="AndroidManifest.xml" parent="/manifest/application">
            <!-- MCE API26 properties -->            
            <meta-data android:name="channelName" android:value="$CHANNEL_NAME" />
            <meta-data android:name="channelDescription" android:value="$CHANNEL_DESCRIPTION" />
            <meta-data android:name="channelId" android:value="$CHANNEL_ID" />

            <!-- MCE properties -->            
            <meta-data android:name="autoReinitialize" android:value="$AUTO_REINITIALIZE" />
            <meta-data android:name="messagingService" android:value="fcm" />
            <meta-data android:name="mceAppKey" android:value="@string/appkey" />
            <meta-data android:name="mceSenderId" android:value="@string/senderid" />
            <meta-data android:name="loglevel" android:value="$LOGLEVEL" />
            <meta-data android:name="mceSessionEnabled" android:value="true" />
            <meta-data android:name="mceSessionDuration" android:value="5" />
            <meta-data android:name="customActions" android:value="$CUSTOM_ACTIONS" />
            <meta-data android:name="mceServer" android:value="$SERVER_URL" />
            <meta-data android:name="invalidateExistingUser" android:value="$INVALIDATE_EXISTING_USER" />
            <meta-data android:name="com.google.android.gms.version" android:value="@integer/google_play_services_version" />

            <!-- GcmReceiver is refquired for handling GCM messages 
            <receiver android:name="com.google.android.gms.gcm.GcmReceiver" android:priority="999">
                <intent-filter android:permission="com.google.android.c2dm.permission.SEND" >
                    <action android:name="com.google.android.c2dm.intent.RECEIVE" />
                    <category android:name="$PACKAGE_NAME" />
                </intent-filter>
                <intent-filter android:permission="com.google.android.c2dm.permission.SEND" android:priority="999">
                    <action android:name="com.google.android.c2dm.intent.REGISTRATION" />
                    <category android:name="$PACKAGE_NAME" />
                </intent-filter>
            </receiver>
            -->

            <receiver android:name="com.ibm.mce.sdk.js.JsonMceBroadcastReceiver">
              <intent-filter>
                <action android:name="com.ibm.mce.sdk.NOTIFIER" />
              </intent-filter>
            </receiver>

            <!-- NotifActionReceiver is required for notification handling -->
            <receiver android:name="com.ibm.mce.sdk.notification.NotifActionReceiver" />

            <!-- AlarmReceiver is required for SDK scheduled tasks and device status updates -->
            <receiver android:name="com.ibm.mce.sdk.wi.AlarmReceiver" >
                <intent-filter>
                    <action android:name="android.intent.action.BOOT_COMPLETED" />
                </intent-filter>
                <intent-filter>
                    <action android:name="android.intent.action.TIMEZONE_CHANGED" />
                </intent-filter>
                <intent-filter>
                    <action android:name="android.intent.action.PACKAGE_REPLACED" />

                    <data android:scheme="package" />
                </intent-filter>
                <intent-filter>
                    <action android:name="android.intent.action.LOCALE_CHANGED" />
                </intent-filter>
            </receiver>

            <!-- The provider is needed for the SDK database -->
            <provider
                android:name="com.ibm.mce.sdk.db.Provider"
                android:authorities="$PACKAGE_NAME.MCE_PROVIDER"
                android:exported="false" />
            <provider
                android:name="com.ibm.mce.sdk.js.Provider"
                android:authorities="$PACKAGE_NAME.MCE_JSON_PROVIDER"
                android:exported="false" />

            <!-- FCM Registration -->
            <service
                android:name="com.ibm.mce.sdk.fcm.FcmInstanceIdService">
                <intent-filter>
                    <action android:name="com.google.firebase.INSTANCE_ID_EVENT"/>
                </intent-filter>
            </service>

            <!-- FCM Messages -->
            <service
                android:name="com.ibm.mce.sdk.fcm.FcmMessagingService">
                <intent-filter>
                    <action android:name="com.google.firebase.MESSAGING_EVENT"/>
                </intent-filter>
            </service>

            <service android:name="com.ibm.mce.sdk.session.SessionTrackingIntentService"/>

            <!-- MceGcmListenerService is required for GCM handling 
            <service android:name="com.ibm.mce.sdk.gcm.MceGcmListenerService" android:exported="false" >
                <intent-filter>
                    <action android:name="com.google.android.c2dm.intent.RECEIVE" />
                </intent-filter>
            </service>
            -->
            <!-- EventsAlarmListener is required for event handling -->
            <service android:name="com.ibm.mce.sdk.events.EventsAlarmListener" />
            <!-- PhoneHomeIntentService is required to allow the client to contact the server to update state -->
            <service android:name="com.ibm.mce.sdk.registration.PhoneHomeIntentService" />
            <!-- RegistrationIntentService is required for SDK registration -->
            <service android:name="com.ibm.mce.sdk.registration.RegistrationIntentService" />
            <!-- AttributesQueueConsumer is required for attributes handling -->
            <service android:name="com.ibm.mce.sdk.attributes.AttributesQueueConsumer" />
            <!-- SnoozeIntentService is optional. It is required only if snooze action is used -->
            <service android:name="com.ibm.mce.sdk.plugin.snooze.SnoozeIntentService" />
            <!-- InboxUpdateService is optional. It is used for retrieving ibox updates from the MCE server. It is required only if inbox is used -->
            <service android:name="com.ibm.mce.sdk.plugin.inbox.InboxUpdateService" />
            <!-- MdeJobService is used for launching a job while the app is in the foreground. This is only used in Android O and above -->
            <service android:name="com.ibm.mce.sdk.job.MceJobService" android:permission="android.permission.BIND_JOB_SERVICE"/>
	
        </config-file>
        <config-file target="res/values/strings.xml" parent="/*">
            <string name="appkey">$ANDROID_APPKEY</string>
            <string name="senderid"></string>
        </config-file>     
        <config-file target="res/xml/config.xml" parent="/widget">
            <feature name="MCEPlugin">
                <param name="android-package" value="com.ibm.mce.plugin.cordova.MceCordovaPlugin" />
            </feature>
        </config-file>
        <source-file src="src/android/gson-2.2.4.jar" target-dir="libs" framework="false" />
        <source-file src="src/android/ibm-mobile-push-android-sdk-3.7.1.2.8.jar" target-dir="libs" framework="false" />
        <source-file src="src/android/ibm-mobile-push-android-js-3.7.1.2.8.jar" target-dir="libs" framework="false" />
        <source-file src="src/android/ibm-mobile-push-android-cordova-3.7.1.2.8.jar" target-dir="libs" framework="false" />
    </platform>
</plugin>
